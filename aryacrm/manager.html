<!doctype html>
<html>
	<head>
       <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
		<title>Arya Fire and Safety</title>
            
     <link rel="stylesheet"  href="css/main-styles.css" />
<link href="dist/css/semantic-ui/tabulator_semantic-ui.min.css" rel="stylesheet">
 <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="dist/js/tabulator.min.js"></script>
      <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.0.5/jspdf.plugin.autotable.js"></script>
    <script>
        if(window.localStorage["token"]==""){ window.location.replace("index.html");}
        
        </script>
	</head>
	<body>
   <div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="btn btn-lg closebtn glyphicon glyphicon-menu-left" onclick="closeNav()"></a>
  <p>Welcome <span id="user">!</span></p><br/>
  <ul class="list-group">
  
  <li class="list-group-item">New Lead<button type="button" id="add_button" data-toggle="modal" data-target="#leadModal" class="btn btn-success">Add</button></li> 
  <li class="list-group-item">Log Out  <button type="button" id="logout_button"class="btn btn-danger"> <span class="glyphicon glyphicon-log-out"></span></button></li> 
</ul>
  
 

</div>
<div class="navbar navbar-default navbar-fixed-top">
    <!-- Use any element to open the sidenav -->
<span id="menu" class="btn btn-lg glyphicon glyphicon-menu-hamburger" onclick="openNav()"></span>
        </div>


<!-- Add all page content inside this div if you want the side nav to push page content to the right (not used if you only want the sidenav to sit on top of the page -->
<div id="main">
  		<div class="container">
            <div><h1 align="center">Leads Management</h1></div>
			
			<div class="box" id="main-body">
                 <div class="row">
                  <!--  <button id="add">Add Lead</button>
                <button id="table">Table</button></div>-->
                <button id="print-table">Print Table</button>
                <button id="download-pdf">Download PDF</button>
                
                <button id="filter-clear" class="pull-right">Clear Filters</button>
                    </div>
				<div class="row">
                   
				
               <div id="example-table" class="celled striped"></div>

				
			</div>
            
		</div>
    </div>
        <footer class="navbar navbar-default navbar-fixed-bottom">
            <h6 class="text-center">App Developed by www.omsolutions.biz</h6>
		</footer>
  </div>
	</body>
</html>
<div id="leadModal" class="modal fade">
	<div class="modal-dialog">
		<form method="post" id="lead_form" enctype="multipart/form-data">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
					<h4 class="modal-title">Add Lead</h4>
				</div>
				<div class="modal-body">
					<label>Enter Company Name</label>
					<input type="text" name="company_name" id="company_name" class="form-control" required="true" value="" />
					<br />
					<label>Enter Contact Name</label>
					<input type="text" name="contact_name" id="contact_name" class="form-control" required="true" value=""/>
					<br />
                    <label>Enter Mobile</label>
					<input type="tel" name="mobile" id="mobile" class="form-control" required="true" value=""/>
					<br />
                    <label>Enter Email-id</label>
					<input type="text" name="email" id="email" class="form-control" value="" />
					<br />
                     <label>Enter Other Details</label>
                    <textarea name="custom_details" id="custom_details" class="form-control" value=""></textarea>
					<br />
                    <label>Enter Address</label>
                    <textarea name="address" id="address" class="form-control" value=""></textarea>
					<br />                   
                    <label>Enter City</label>
                    <input type="text" name="city" id="city" class="form-control" required="true" value=""/>
					<br />
                   <label>Enter Industry Sector</label>
                    <input type="text" name="sector" id="sector" class="form-control" required="true" value=""/>
					<br />
                    <label>Visit Date</label>
                    <input type="date" name="visit_date" id="visit_date" class="form-control" value=""/>
					<br />
                    <label>Marketing Person</label>
                    <input type="text" name="marketing_name" id="marketing_name" class="form-control" value=""/>
					<br />
                    <label>Result</label>
                   <textarea name="result" id="result" class="form-control" value=""></textarea>
					<br />
                    <label>Feedback</label>
                    <textarea name="feedback" id="feedback" class="form-control" value=""></textarea>
					<br />
                    
				</div>
				<div class="modal-footer">
					<input type="hidden" name="lead_id" id="lead_id" />
					<input type="hidden" name="operation" id="operation" />
                     <input type="hidden" name="usertoken" id="usertoken" />
                    <input type="submit" name="action" id="action" class="btn btn-success" value="Add" />
                    <span id="delete"></span>
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</form>
	</div>
</div>



<script type="text/javascript" language="javascript" >

function init() {
    //Check Token
    $.ajax({
    url:"check_token.php",
    method:"POST",
    data:{token: window.localStorage["token"] , name: window.localStorage["name"] },
    cache:false,
    dataType:"json",
    success:function(data)
    {
         
     window.localStorage["token"]=data.token;
     window.localStorage["name"]=data.name; 
     window.localStorage["logged_in"]=data.logged_in;
     window.localStorage["user"]=data.user;
   
     }
    
   });
    ////Check Token End////////////////////////         
}    
    
 /* Set the width of the side navigation to 250px */
function openNav() {
  document.getElementById("mySidenav").style.width = "200px";
    
}

/* Set the width of the side navigation to 0 */
function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
}
    
$(document).ready(function(){
  
setInterval(function(){
         init()
 },18000000); 
 setInterval(function(){
         checkLogin()
 },2000); 
 
    
	function checkLogin(){
	if (window.localStorage["logged_in"]!="true"){
        document.getElementById("menu").style.visibility="hidden";
        console.log("login Failed");
       document.getElementById("main-body").innerHTML='<div class="alert alert-danger">Login is Required to Use this App</div><button  id="login_button" type="button" class="btn btn-primary btn-block btn-lg">Login</button';
       // alert("Login Required");
        document.getElementById("login_button").onclick= function(){  window.location.replace("index.html");  }
    
    }else{
      console.log("login success");
        document.getElementById("user").innerHTML=window.localStorage["name"]+ '!';
    }
    }
   
      if (window.localStorage["logged_in"]=="true"){
          init()
          
           //fetch Data
 

         //Build Tabulator
var table = new Tabulator("#example-table", {
    layout:"fitDataStretch",
    ajaxURL:"fetch.php", //ajax URL
    ajaxConfig:"POST", //ajax HTTP request type
    ajaxContentType:"json", // send parameters to the server as a JSON encoded string
    height:"450px",  
    pagination:"local",
    paginationSize:10,
    
    printAsHtml:true,
    headerFilterLiveFilterDelay:600, //wait 600ms from last keystroke before triggering filter
   
    downloadRowRange:"active", //change default selector to selected
    columns:[
        //{formatter:"responsiveCollapse", width:"5%", minWidth:"5%", hozAlign:"center", resizable:false, headerSort:false},
        {title:"Company Name", field:"company_name", sorter:"string", headerFilter:"input", headerFilterPlaceholder:"Filter Company"},
        {title:"Contact Name", field:"contact_name", sorter:"string", headerFilter:"input", headerFilterPlaceholder:"Filter Company"},
        {title:"Mobile", field:"mobile", sorter:"string"},
        {title:"Email", field:"email", sorter:"string"},
        {title:"Other Detail", field:"custom_detail", sorter:"string"},
        {title:"Industry", field:"sector", sorter:"string",headerFilter:"select", headerFilterParams:{values:true},headerFilterPlaceholder:"Select Industry"},
        {title:"City", field:"city", sorter:"string",headerFilter:"select", headerFilterParams:{values:true},headerFilterPlaceholder:"Select City"},
        {title:"Address", field:"address", sorter:"string"},
        {title:"Visit Date", field:"visit_date", sorter:"string"},
        {title:"Result", field:"result", sorter:"string"},
        {title:"Marketing Person", field:"marketing_name", sorter:"string",headerFilter:"select", headerFilterParams:{values:true},headerFilterPlaceholder:"Select"},
        {title:"Feedback", field:"feedback", sorter:"string"},
                
        ],
    rowClick:function(e, row){
        // alert("Row " + row.getData().company_name+ " Clicked!!!!")
        var lead_id=row.getData().id;
        $.ajax({
			url:"fetch_single.php",
			method:"POST",
			data:{lead_id:lead_id},
			dataType:"json",
			success:function(data)
			{
				$('#leadModal').modal('show');
                document.getElementById("delete").innerHTML='<button type="button" id="delete_button" class="btn btn-danger">Delete</button>';
                $('.modal-title').text("Edit Lead");
                $('#company_name').val(data.company_name);
                $('#contact_name').val(data.contact_name);
                $('#mobile').val(data.mobile);
                $('#email').val(data.email);
                $('#custom_details').val(data.custom_detail);
                $('#address').val(data.address);
                $('#city').val(data.city);
                $('#sector').val(data.sector);
                $('#visit_date').val(data.visit_date);
                $('#marketing_name').val(data.marketing_name);
                $('#result').val(data.result);
                $('#feedback').val(data.feedback);
                $('#lead_id').val(lead_id);
				$('#usertoken').val(window.localStorage["token"]);
				$('#action').val("Edit");
                
				$('#operation').val("Edit");
			}
		})
        
    },
});

        
      }
    
    //Clear filters on "Clear Filters" button click
document.getElementById("filter-clear").addEventListener("click", function(){
  
   table.clearFilter(true);
});
    
    //print & download button
document.getElementById("print-table").addEventListener("click", function(){
   table.print("active",true, true);
});
   
document.getElementById("download-pdf").addEventListener("click", function(){
     table.download("pdf", "data.pdf", {
        orientation:"landscape", //set page orientation to portrait
        title:"Example Report", //add title to report
    });
});

    //print & download function end
    
	$('#logout_button').click(function(){
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("menu").style.visibility="hidden";
    window.localStorage["logged_in"]="false";
      window.localStorage["token"]="";
        window.localStorage["name"]="";
        window.localStorage["user"]="";
        window.location.replace("index.html");
	});
    
    $('#add_button').click(function(){
        document.getElementById("mySidenav").style.width = "0";
		$('#lead_form')[0].reset();
        document.getElementById("delete").innerHTML='';
		$('.modal-title').text("Add Lead");
		$('#action').val("Add");
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;
        $('#visit_date').val(today);
		$('#operation').val("Add");
        $('#usertoken').val(window.localStorage["token"]);
		
	});
    
   $(document).on('submit', '#lead_form', function(event){
      
		event.preventDefault();
		var companyName = $('#company_name').val();
		var contactName = $('#contact_name').val();
         var usertoken = $('#usertoken').val();
		
		
		if(companyName != '' && contactName != '')
		{
			$.ajax({
				url:"insert.php",
				method:'POST',
				data:new FormData(this),
				contentType:false,
				processData:false,
				success:function(data)
				{
					alert(data);
                    //console.log();
					$('#lead_form')[0].reset();
					$('#leadModal').modal('hide');
					table.setData();
                    
                
				}
			});
		}
		else
		{
			alert("Please fill all required data");
		}
	});
	
	
 
	
	$('#delete').click(function(){
		var lead_id = $('#lead_id').val();
		if(confirm("Are you sure you want to delete this?"))
		{
            
			$.ajax({
				url:"delete.php",
				method:"POST",
				data:{lead_id:lead_id},
				success:function(data)
				{
					alert(data);
					$('#leadModal').modal('hide');
					table.setData();
				}
			});
		}
		else
		{
			return false;	
		}
	});

	
	
});
</script>